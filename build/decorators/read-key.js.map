{"version":3,"sources":["../../src/decorators/read-key.js"],"names":["micro","client","key","callback","options","Promise","resolve","reject","get","err","result","logger","error","code","message","promise","then","JSON","parse","type","value","to"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;;;kBAEe,UAACA,KAAD,EAAQC,MAAR;AAAA,SAAmB,UAACC,GAAD,EAAMC,QAAN;AAAA,QAAgBC,OAAhB,uEAA0B,EAA1B;AAAA,WAAiC,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAClGN,aAAOO,GAAP,CAAWN,GAAX,EAAgB,UAAUO,GAAV,EAAeC,MAAf,EAAuB;AACrC,YAAID,GAAJ,EAAS;AACPT,gBAAMW,MAAN,CAAaC,KAAb,CAAmBH,GAAnB;AACA,iBAAOF,OAAO;AACZM,oDAA0CJ,IAAII,IADlC;AAEZC,2JAAqCZ,GAArC;AAFY,WAAP,CAAP;AAID;;AAED,YAAIQ,WAAW,IAAf,EAAqB;;AAEnB,cAAI,sBAAWP,QAAX,CAAJ,EAA0B;AACxB,gBAAIY,UAAUZ,SAASD,GAAT,CAAd;;AAEA,gBAAI,CAACa,OAAD,IAAY,EAAE,UAAUA,OAAV,IAAqB,sBAAWA,QAAQC,IAAnB,CAAvB,CAAhB,EAAkE;AAChED,wBAAUV,QAAQC,OAAR,CAAgBS,OAAhB,CAAV;AACD;;AAED,mBAAOA,QACJC,IADI,CACC;AAAA,qBAAU,wBAAMhB,KAAN,EAAaC,MAAb,EAAqBC,GAArB,EAA0BQ,MAA1B,CAAV;AAAA,aADD,EAEJM,IAFI,CAECV,OAFD,EAEUC,MAFV,CAAP;AAGD;;AAED,iBAAOD,QAAQI,MAAR,CAAP;AACD;;AAxBoC,0BA0BfO,KAAKC,KAAL,CAAWR,MAAX,CA1Be;AAAA,YA0B/BS,IA1B+B,eA0B/BA,IA1B+B;AAAA,YA0BzBC,KA1ByB,eA0BzBA,KA1ByB;;AA4BrCd,gBAAQ,iBAAOe,EAAP,CAAUD,KAAV,EAAiBD,IAAjB,CAAR;AACD,OA7BD;AA8BD,KA/BkE,CAAjC;AAAA,GAAnB;AAAA,C","file":"read-key.js","sourcesContent":["import isFunction from 'lodash.isfunction';\nimport upcast from '../utils/upcast';\nimport write from './write-key';\n\nexport default (micro, client) => (key, callback, options = {}) => new Promise((resolve, reject) => {\n  client.get(key, function (err, result) {\n    if (err) {\n      micro.logger.error(err);\n      return reject({\n        code   : `error.plugin-cache-redis.get/${ err.code }`,\n        message: `Попытка получения ключа ${ key } привела к ошибке`\n      });\n    }\n    \n    if (result === null) {\n      \n      if (isFunction(callback)) {\n        let promise = callback(key);\n        \n        if (!promise || !('then' in promise && isFunction(promise.then))) {\n          promise = Promise.resolve(promise);\n        }\n        \n        return promise\n          .then(result => write(micro, client)(key, result))\n          .then(resolve, reject);\n      }\n      \n      return resolve(result);\n    }\n    \n    let { type, value } = JSON.parse(result);\n    \n    resolve(upcast.to(value, type));\n  });\n});"]}